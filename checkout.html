<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thanh to√°n</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7eee7;margin:0;color:#333}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.06);margin-bottom:16px}
    h1{font-size:24px;margin:0 0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full{grid-column:1/-1}
    label{display:block;font-size:14px;margin-bottom:6px;color:#555}
    input,textarea{width:100%;box-sizing:border-box;padding:12px 14px;border:1px solid #ddd;border-radius:10px;background:#fafafa}
    textarea{min-height:90px;resize:vertical}
    .btn{display:inline-block;padding:12px 18px;border-radius:12px;border:none;background:#111;color:#fff;cursor:pointer;font-weight:600}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:#666;font-size:14px}
    .right{float:right}
    .total{font-weight:700}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
    .ok{color:#0a7a3e}
    .warn{color:#b65700}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Thanh to√°n</h1>

    <div class="card">
      <p class="muted">
        Ph∆∞∆°ng √°n nhanh: g·ª≠i form qua <b>FormSubmit</b> ‚Üí m·ªü tab m·ªõi, g·ª≠i email v·ªÅ h·ªôp th∆∞ c·ªßa b·∫°n.
      </p>
      <p class="muted">üí° L·∫ßn g·ª≠i ƒë·∫ßu ti√™n FormSubmit s·∫Ω g·ª≠i email x√°c minh. B·∫•m x√°c minh xong l√† ch·∫°y vƒ©nh vi·ªÖn.</p>
    </div>

    <form id="checkoutForm" class="card" action="https://formsubmit.co/anmy1909@email.com"
          method="POST" target="_blank" rel="noopener noreferrer">
      <div class="grid">
        <div>
          <label for="email">Email</label>
          <input id="email" name="Email" type="email" required placeholder="anmy1909@email.com"/>
        </div>
        <div>
          <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
          <input id="phone" name="SƒêT" type="tel" required placeholder="09xxxxxxxx"/>
        </div>
        <div class="full">
          <label for="address">ƒê·ªãa ch·ªâ</label>
          <input id="address" name="ƒê·ªãa_ch·ªâ" type="text" required placeholder="S·ªë nh√†, ƒë∆∞·ªùng, qu·∫≠n/huy·ªán, t·ªânh/th√†nh"/>
        </div>
        <div class="full">
          <label for="note">Ghi ch√∫</label>
          <textarea id="note" name="Ghi_ch√∫" placeholder="Y√™u c·∫ßu th√™m (n·∫øu c√≥)"></textarea>
        </div>
      </div>

      <!-- C√°c tr∆∞·ªùng ·∫©n ƒë·ªÉ g·ªüi k√®m ƒë∆°n -->
      <input type="hidden" name="M√£_ƒë∆°n" id="orderId">
      <input type="hidden" name="Gi·ªè_h√†ng" id="cartText">
      <input type="hidden" name="T·ªïng_ti·ªÅn" id="totalText">
      <input type="hidden" name="Cart_JSON" id="cartJson">

      <!-- C·∫•u h√¨nh FormSubmit -->
      <input type="hidden" name="_subject" value="ƒê∆°n h√†ng m·ªõi t·ª´ website">
      <input type="hidden" name="_captcha" value="false">
      <input type="hidden" name="_template" value="table">
      <input type="hidden" name="_next" value="/thanks.html"> <!-- Trang c·∫£m ∆°n sau khi g·ª≠i -->

      <button class="btn" type="submit">G·ª≠i ƒë∆°n</button>
      <span id="guard" class="muted right"></span>
    </form>

    <div class="card">
      <table class="table" id="cartPreview">
        <thead>
          <tr><th>S·∫£n ph·∫©m</th><th>SL</th><th>Th√†nh ti·ªÅn</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td class="total">T·ªïng c·ªông</td><td></td><td class="total" id="sumCell">0ƒë</td></tr>
        </tfoot>
      </table>
    </div>
  </div>

  <script>
    // ---- L·∫•y gi·ªè h√†ng t·ª´ localStorage (th·ª≠ nhi·ªÅu key ph·ªï bi·∫øn) ----
    const keys = ['cart','gioHang','cartItems'];
    let raw = '[]';
    for (const k of keys){
      const v = localStorage.getItem(k);
      if (v && v !== '[]' && v !== '{}'){ raw = v; break; }
    }
    let items = [];
    try { items = JSON.parse(raw) || []; } catch(e){ items = []; }

    // Chu·∫©n ho√° item (ƒë·ªÅ ph√≤ng c·∫•u tr√∫c kh√°c nhau)
    const norm = i => ({
      name: i.name || i.title || i.productName || 'S·∫£n ph·∫©m',
      qty:  Number(i.qty ?? i.quantity ?? i.count ?? 1),
      price: Number(i.price ?? i.unitPrice ?? i.gia ?? 0)
    });

    const neatVND = n => (Number(n)||0).toLocaleString('vi-VN') + 'ƒë';
    const nitems = items.map(norm);
    const lines = nitems.map(i => `${i.name} x${i.qty} ‚Äî ${neatVND(i.price*i.qty)}`);
    const total = nitems.reduce((s,i)=> s + i.price*i.qty, 0);

    // ƒê·ªï preview gi·ªè h√†ng
    const tbody = document.querySelector('#cartPreview tbody');
    if (nitems.length){
      tbody.innerHTML = nitems.map(i =>
        `<tr><td>${i.name}</td><td>${i.qty}</td><td>${neatVND(i.price*i.qty)}</td></tr>`
      ).join('');
    } else {
      tbody.innerHTML = `<tr><td colspan="3" class="muted">Gi·ªè h√†ng tr·ªëng.</td></tr>`;
    }
    document.getElementById('sumCell').textContent = neatVND(total);

    // ƒêi·ªÅn v√†o c√°c tr∆∞·ªùng ·∫©n
    const orderId = 'DH' + Date.now().toString(36).toUpperCase();
    document.getElementById('orderId').value   = orderId;
    document.getElementById('cartText').value  = lines.join('\n');
    document.getElementById('totalText').value = neatVND(total);
    document.getElementById('cartJson').value  = JSON.stringify(nitems);

    // B·∫£o v·ªá: ch·∫∑n g·ª≠i n·∫øu gi·ªè h√†ng tr·ªëng
    const form = document.getElementById('checkoutForm');
    const guard = document.getElementById('guard');
    form.addEventListener('submit', (e)=>{
      if (!nitems.length){
        e.preventDefault();
        guard.textContent = 'Gi·ªè h√†ng tr·ªëng, kh√¥ng th·ªÉ g·ª≠i.';
        guard.className = 'muted warn right';
        return;
      }
      guard.textContent = `ƒêang m·ªü tab g·ª≠i ƒë∆°n‚Ä¶ (${orderId})`;
      guard.className = 'muted ok right';
    });
  </script>
</body>
</html>
