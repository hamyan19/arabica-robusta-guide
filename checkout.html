<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ANARO ‚Äî Checkout</title>
  <style>
    :root{
      --bg:#fffdf9;
      --text:#2a221d;
      --muted:#6e625a;
      --border:#eadfd4;
      --brand:#7a4b2b;
      --error:#dc3545;
      --success:#28a745;
      --warning:#ffc107;
    }
    
    *{box-sizing:border-box}
    
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
    }
    
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:20px 16px;
    }
    
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 0;
      border-bottom:1px solid var(--border);
      margin-bottom:20px;
    }
    
    h1{
      margin:0;
      font-size:22px;
    }
    
    .grid{
      display:grid;
      grid-template-columns:1.2fr .8fr;
      gap:24px;
      margin-top:16px;
    }
    
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:20px;
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
    }
    
    .title{
      margin:0 0 16px 0;
      font-size:18px;
      font-weight:600;
      color:var(--brand);
    }
    
    .form-group{
      margin-bottom:16px;
    }
    
    label{
      font-size:14px;
      font-weight:600;
      color:var(--brand);
      display:block;
      margin-bottom:6px;
    }
    
    .required{
      color:var(--error);
    }
    
    input[type="text"], 
    input[type="email"], 
    textarea{
      padding:12px 16px;
      border:2px solid #e1e5e9;
      border-radius:8px;
      width:100%;
      font-size:16px; /* Prevent zoom on iOS */
      transition:border-color 0.2s ease, box-shadow 0.2s ease;
      background:#fff;
    }
    
    input[type="text"]:focus, 
    input[type="email"]:focus, 
    textarea:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(122,75,43,0.1);
    }
    
    textarea{
      min-height:100px;
      resize:vertical;
      font-family:inherit;
    }
    
    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }
    
    .gender{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:8px;
    }
    
    .opt{
      display:flex;
      gap:8px;
      align-items:center;
      padding:12px 16px;
      border:2px solid #e1e5e9;
      border-radius:8px;
      background:#fff;
      cursor:pointer;
      transition:all 0.2s ease;
      min-height:48px; /* Touch-friendly */
    }
    
    .opt:hover{
      border-color:var(--brand);
      background:#f8f9fa;
    }
    
    .opt input[type="radio"]{
      margin:0;
    }
    
    .opt input[type="radio"]:checked + span,
    .opt:has(input[type="radio"]:checked){
      border-color:var(--brand);
      background:rgba(122,75,43,0.1);
      font-weight:600;
    }
    
    .line{
      display:flex;
      justify-content:space-between;
      margin:8px 0;
      padding:4px 0;
    }
    
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:14px 20px;
      border-radius:8px;
      border:2px solid transparent;
      background:#f1f3f4;
      color:var(--text);
      font-weight:600;
      cursor:pointer;
      text-decoration:none;
      transition:all 0.2s ease;
      min-height:48px; /* Touch-friendly */
      font-size:16px;
    }
    
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    
    .btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }
    
    .cta{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    
    .cta:hover:not(:disabled){
      background:#654032;
      border-color:#654032;
    }
    
    .back-btn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 16px;
      border-radius:8px;
      background:#d88c5d;
      color:#fff;
      font-weight:600;
      text-decoration:none;
      transition:all 0.2s ease;
      min-height:44px;
    }
    
    .back-btn:hover {
      background:#8b4a2d;
      transform:translateY(-1px);
    }
    
    .srow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:16px;
    }
    
    .ico{
      width:20px;
      height:20px;
      display:inline-block;
    }
    
    footer{
      margin-top:32px;
      color:var(--muted);
      font-size:14px;
      text-align:center;
      padding:20px 0;
      border-top:1px solid var(--border);
    }
    
    .toast{
      position:fixed;
      left:50%;
      top:20px;
      transform:translateX(-50%);
      background:var(--text);
      color:#fff;
      padding:12px 20px;
      border-radius:8px;
      z-index:9999;
      font-weight:500;
      box-shadow:0 4px 16px rgba(0,0,0,0.2);
    }
    
    .toast.error{
      background:var(--error);
    }
    
    .toast.success{
      background:var(--success);
    }

    /* Payment Methods */
    .payment-methods{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    
    .payment-option{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:16px;
      border:2px solid #e1e5e9;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.2s ease;
      background:#fff;
    }
    
    .payment-option:hover{
      border-color:var(--brand);
      background:#f8f9fa;
    }
    
    .payment-option:has(input:checked){
      border-color:var(--brand);
      background:rgba(122,75,43,0.05);
    }
    
    .payment-option input[type="radio"]{
      margin:2px 0 0 0;
      accent-color:var(--brand);
    }
    
    .payment-content{
      flex:1;
    }
    
    .payment-content strong{
      display:block;
      font-size:15px;
      margin-bottom:4px;
    }
    
    .payment-content small{
      color:var(--muted);
      font-size:13px;
    }

    /* QR Code Section */
    .qr-section{
      margin-top:16px;
      padding:20px;
      background:#f8f9fa;
      border-radius:10px;
      border:1px dashed var(--brand);
    }
    
    .qr-container{
      display:flex;
      gap:20px;
      align-items:flex-start;
    }
    
    .qr-code{
      width:160px;
      height:160px;
      background:#fff;
      border:2px solid var(--border);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }
    
    .qr-placeholder{
      text-align:center;
      color:var(--muted);
      font-size:12px;
    }
    
    .qr-loading{
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .qr-loading::before{
      content:'';
      width:16px;
      height:16px;
      border:2px solid var(--border);
      border-top:2px solid var(--brand);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
    
    .qr-info{
      flex:1;
    }
    
    .qr-info h4{
      margin:0 0 12px 0;
      font-size:15px;
      color:var(--brand);
    }
    
    .bank-info{
      background:#fff;
      padding:12px;
      border-radius:6px;
      font-size:13px;
      margin-bottom:12px;
    }
    
    .bank-info div{
      margin:4px 0;
    }
    
    .qr-timer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    
    .btn-small{
      padding:6px 12px;
      font-size:12px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:6px;
      cursor:pointer;
      transition:all 0.2s ease;
    }
    
    .btn-small:hover{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }

    /* Progress Indicator */
    .progress-bar{
      background:#e1e5e9;
      height:4px;
      border-radius:2px;
      margin:16px 0;
      overflow:hidden;
    }
    
    .progress-fill{
      background:var(--brand);
      height:100%;
      border-radius:2px;
      transition:width 0.3s ease;
      width:80%; /* Step 2 of 2 */
    }

    /* Order Summary Enhancements */
    .order-badge{
      display:inline-block;
      background:var(--brand);
      color:#fff;
      padding:4px 8px;
      border-radius:4px;
      font-size:12px;
      font-weight:600;
      margin-left:8px;
    }
    .error-input{
      border-color:var(--error) !important;
      box-shadow:0 0 0 3px rgba(220,53,69,0.1) !important;
    }
    
    .error-message{
      color:var(--error);
      font-size:13px;
      margin-top:4px;
      display:block;
    }
    
    .loading{
      position:relative;
      overflow:hidden;
    }
    
    .loading::after{
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation:loading 1.5s infinite;
    }
    
    @keyframes loading{
      0%{left:-100%}
      100%{left:100%}
    }

    /* Popup modal */
    .backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      backdrop-filter:blur(4px);
    }
    
    .modal{
      width:min(520px,92vw);
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,0.2);
      padding:24px;
      transform:scale(0.9);
      transition:transform 0.2s ease;
    }
    
    .backdrop.show .modal{
      transform:scale(1);
    }
    
    .modal h3{
      margin:0 0 8px;
      font-size:20px;
      color:var(--brand);
    }
    
    .modal p{
      margin:8px 0 16px;
      color:var(--muted);
    }
    
    .modal .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }

    /* Mobile Responsive */
      @media (max-width: 768px) {
      .wrap{
        padding:16px 12px;
      }
      
      header{
        flex-direction:column;
        gap:12px;
        align-items:stretch;
      }
      
      header h1{
        font-size:20px;
        text-align:center;
      }
      
      .grid{
        grid-template-columns:1fr; /* Single column on mobile */
        gap:20px;
      }
      
      .card{
        padding:16px;
      }
      
      .title{
        font-size:16px;
      }
      
      .row2{
        grid-template-columns:1fr; /* Stack on mobile */
        gap:12px;
      }
      
      .gender{
        grid-template-columns:1fr; /* Stack gender options */
      }
      
      .btn{
        padding:16px 20px; /* Larger touch targets */
        font-size:16px;
      }
      
      .srow{
        flex-direction:column;
      }
      
      .srow .btn{
        justify-content:center;
      }
      
      .modal{
        margin:16px;
        padding:20px;
      }
      
      .modal .row{
        flex-direction:column;
      }
      
      .modal .btn{
        justify-content:center;
      }
      
      /* QR Code responsive */
      .qr-container{
        flex-direction:column;
        align-items:center;
        text-align:center;
      }
      
      .qr-code{
        width:200px;
        height:200px;
        margin-bottom:16px;
      }
      
      .qr-timer{
        flex-direction:column;
        gap:8px;
        text-align:center;
      }
      
      /* Order summary on mobile - make it more compact */
      .card:last-child .line{
        margin:6px 0;
        font-size:15px;
      }
      
      #co-items{
        font-size:14px;
        line-height:1.5;
      }
    }
    
    @media (max-width: 480px) {
      .wrap{
        padding:12px 8px;
      }
      
      .card{
        padding:12px;
        border-radius:8px;
      }
      
      input[type="text"], 
      input[type="email"], 
      textarea{
        padding:14px 12px; /* Larger for easier tapping */
      }
      
      .btn{
        padding:18px 16px;
        font-size:16px;
      }
      
      .modal{
        margin:8px;
        padding:16px;
        border-radius:12px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>‚òï ANARO COFFEE ‚Äî Thanh to√°n</h1>
      <a href="index.html" class="back-btn">‚Üê V·ªÅ trang ch·ªß</a>
    </header>

    <div class="grid">
      <!-- LEFT: Customer Info -->
      <section class="card">
        <h2 class="title">Th√¥ng tin ng∆∞·ªùi nh·∫≠n</h2>
        
        <div class="row2">
          <div class="form-group">
            <label for="recipient">T√™n ng∆∞·ªùi nh·∫≠n <span class="required">*</span></label>
            <input id="recipient" type="text" placeholder="VD: Nguy·ªÖn VƒÉn A" required>
            <span class="error-message" id="recipient-error"></span>
          </div>
          
          <div class="form-group">
            <label>Gi·ªõi t√≠nh (x∆∞ng h√¥)</label>
            <div class="gender">
              <label class="opt">
                <input type="radio" name="gender" value="Anh" checked>
                <span>Anh</span>
              </label>
              <label class="opt">
                <input type="radio" name="gender" value="Ch·ªã">
                <span>Ch·ªã</span>
              </label>
              <label class="opt">
                <input type="radio" name="gender" value="Kh√°c">
                <span>Kh√°c</span>
              </label>
            </div>
          </div>
        </div>
        
        <div class="row2">
          <div class="form-group">
            <label for="email">Email <span class="required">*</span></label>
            <input id="email" type="email" placeholder="you@example.com" required>
            <span class="error-message" id="email-error"></span>
          </div>
          
          <div class="form-group">
            <label for="phone">S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
            <input id="phone" type="text" placeholder="09xx xxx xxx" required>
            <span class="error-message" id="phone-error"></span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="note">Ghi ch√∫</label>
          <textarea id="note" placeholder="Ghi ch√∫ th√™m (khung gi·ªù nh·∫≠n, ƒë·ªãa ch·ªâ chi ti·∫øt, v.v.)"></textarea>
        </div>

        <h3 class="title" style="margin-top:24px">Li√™n h·ªá / X√°c nh·∫≠n ƒë∆°n</h3>
        <div class="srow">
          <a id="linkZalo" class="btn" target="_blank" rel="noopener" href="https://zalo.me/84918337071" aria-label="Zalo">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="5" ry="5" fill="#0068FF"></rect><text x="6.7" y="16.5" font-family="Segoe UI, Roboto, Helvetica, Arial" font-size="10" fill="#fff" font-weight="700">Z</text></svg>
            </span>
            <span>Zalo</span>
          </a>
          <a id="linkMsg" class="btn" target="_blank" rel="noopener" href="https://m.me/anarocoffee" aria-label="Messenger">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#0099FF"></circle><path d="M6.5 14.2l4.1-3.1 3.1 3.1 3.3-3.1" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            </span>
            <span>Messenger</span>
          </a>
          <a id="linkFan" class="btn" target="_blank" rel="noopener" href="https://www.facebook.com/anarocoffee/" aria-label="Fanpage Facebook">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="5" ry="5" fill="#1877F2"></rect><path d="M14 8h2V6h-2a3 3 0 0 0-3 3v2H9v2h2v5h2v-5h2l1-2h-3V9a1 1 0 0 1 1-1z" fill="#fff"></path></svg>
            </span>
            <span>Fanpage</span>
          </a>
        </div>
      </section>

      <!-- RIGHT: Order Summary -->
      <section class="card">
        <h2 class="title">
          ƒê∆°n h√†ng 
          <span class="order-badge" id="order-code">ƒêang t·∫°o...</span>
        </h2>
        
        <div class="progress-bar">
          <div class="progress-fill"></div>
        </div>
        
        <div class="line"><strong>Ti·ªÅn h√†ng</strong><span id="co-subtotal">789.000ƒë</span></div>
        <div class="line"><span>C√¢n n·∫∑ng</span><span id="co-weight">2.25 kg</span></div>
        <div class="line"><span>Ph√≠ ship</span><span id="co-ship">39.000ƒë</span></div>
        <div class="line" style="border-top:2px solid var(--border);padding-top:8px;margin-top:8px;">
          <strong style="font-size:18px;">T·ªïng</strong>
          <strong id="co-total" style="font-size:18px;color:var(--brand);">828.000ƒë</strong>
        </div>
        <div class="muted" id="co-items" style="margin-top:12px;padding:12px;background:#f8f9fa;border-radius:6px;font-size:14px;">
          ‚Ä¢ Blend S·ªë 3 ‚Äî 250g ‚Äî Nguy√™n h·∫°t √ó 5<br>
          ‚Ä¢ Robusta Honey ‚Äî 250g ‚Äî Nguy√™n h·∫°t √ó 1<br>
          ‚Ä¢ Blend S·ªë 2 ‚Äî 250g ‚Äî Nguy√™n h·∫°t √ó 1<br>
          ‚Ä¢ Blend S·ªë 9 ‚Äî 250g ‚Äî Nguy√™n h·∫°t √ó 1<br>
          ‚Ä¢ Arabica C·∫ßu ƒê·∫•t ‚Äî 250g ‚Äî Nguy√™n h·∫°t √ó 1
        </div>
        <!-- Payment Methods -->
        <h3 class="title" style="margin-top:20px;">Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
        <div class="payment-methods">
          <label class="payment-option">
            <input type="radio" name="payment" value="confirm" checked>
            <div class="payment-content">
              <strong>üìû X√°c nh·∫≠n qua ƒëi·ªán tho·∫°i</strong>
              <small>ƒê·∫∑t h√†ng tr∆∞·ªõc, thanh to√°n khi nh·∫≠n</small>
            </div>
          </label>
          <label class="payment-option">
            <input type="radio" name="payment" value="qr">
            <div class="payment-content">
              <strong>üì± Chuy·ªÉn kho·∫£n QR</strong>
              <small>Thanh to√°n ngay, giao h√†ng ∆∞u ti√™n</small>
            </div>
          </label>
        </div>

        <!-- QR Code Section (hidden by default) -->
        <div id="qr-section" class="qr-section" style="display:none;">
          <div class="qr-container">
            <div class="qr-code" id="qr-code">
              <div class="qr-placeholder">
                <div class="qr-loading">ƒêang t·∫°o m√£ QR...</div>
              </div>
            </div>
            <div class="qr-info">
              <h4>Th√¥ng tin chuy·ªÉn kho·∫£n</h4>
              <div class="bank-info">
                <div><strong>Ng√¢n h√†ng:</strong> MB BANK</div>
                <div><strong>S·ªë TK:</strong>90919091986</div>
                <div><strong>T√™n TK:</strong> HA MY AN</div>
                <div><strong>S·ªë ti·ªÅn:</strong> <span id="qr-amount">828.000ƒë</span></div>
                <div><strong>N·ªôi dung:</strong> <span id="qr-content">ANR20250815001</span></div>
              </div>
              <div class="qr-timer">
                <div>M√£ QR h·∫øt h·∫°n sau: <span id="timer">10:00</span></div>
                <button id="refresh-qr" class="btn-small">üîÑ L√†m m·ªõi</button>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:20px">
          <button id="placeOrder" class="btn cta" style="width:100%;">
            <span id="order-text">ƒê·∫∑t h√†ng</span>
            <span id="order-loading" style="display:none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2V6M12 18V22M4.93 4.93L7.76 7.76M16.24 16.24L19.07 19.07M2 12H6M18 12H22M4.93 19.07L7.76 16.24M16.24 7.76L19.07 4.93" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              ƒêang g·ª≠i...
            </span>
          </button>
        </div>
      </section>
    </div>

    <footer>ANARO COFFEE ¬∑ ¬© 2025</footer>
  </div>

  <!-- Success popup -->
  <div id="backdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="okTitle">
    <div class="modal">
      <h3 id="okTitle">üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!</h3>
      <p id="okSub">
        M√£ ƒë∆°n h√†ng: <strong id="success-order-code">ANR-20250815-001</strong><br>
        C·∫£m ∆°n b·∫°n! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá x√°c nh·∫≠n s·ªõm nh·∫•t.
      </p>
      <div class="row">
        <a class="btn" href="index.html">‚Üê Ti·∫øp t·ª•c mua</a>
        <a id="okZalo" class="btn" target="_blank" rel="noopener" href="https://zalo.me/84918337071">Zalo</a>
        <a id="okMsg" class="btn" target="_blank" rel="noopener" href="https://m.me/anarocoffee">Messenger</a>
        <a id="okFan" class="btn" target="_blank" rel="noopener" href="https://www.facebook.com/anarocoffee/">Fanpage</a>
      </div>
    </div>
  </div>

  <script>
    // ====== Config ======
    const FORM_EMAIL = "anmy1909@gmail.com";
    const FORM_ENDPOINT = "https://formsubmit.co/ajax/" + encodeURIComponent(FORM_EMAIL);

    // Social links
    const SOCIAL_LINKS = {
      zalo: "https://zalo.me/84918337071",
      messenger: "https://m.me/anarocoffee",
      fanpage: "https://www.facebook.com/anarocoffee/"
    };

    // ====== Validation ======
    function validateName(name) {
      if (!name || name.length < 2) return "T√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±";
      if (name.length > 50) return "T√™n kh√¥ng ƒë∆∞·ª£c qu√° 50 k√Ω t·ª±";
      return null;
    }

    function validateEmail(email) {
      if (!email) return "Email l√† b·∫Øt bu·ªôc";
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) return "Email kh√¥ng h·ª£p l·ªá";
      return null;
    }

    function validatePhone(phone) {
      if (!phone) return "S·ªë ƒëi·ªán tho·∫°i l√† b·∫Øt bu·ªôc";
      // Vietnamese phone number patterns
      const phoneRegex = /^(0|\+84)[3|5|7|8|9][0-9]{8}$/;
      const cleanPhone = phone.replace(/[\s\-\.]/g, '');
      if (!phoneRegex.test(cleanPhone)) return "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá";
      return null;
    }

    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      const errorSpan = document.getElementById(fieldId + '-error');
      
      if (message) {
        field.classList.add('error-input');
        if (errorSpan) errorSpan.textContent = message;
      } else {
        field.classList.remove('error-input');
        if (errorSpan) errorSpan.textContent = '';
      }
    }

    function validateForm() {
      const name = document.getElementById('recipient').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();

      let isValid = true;

      // Validate name
      const nameError = validateName(name);
      showFieldError('recipient', nameError);
      if (nameError) isValid = false;

      // Validate email
      const emailError = validateEmail(email);
      showFieldError('email', emailError);
      if (emailError) isValid = false;

      // Validate phone
      const phoneError = validatePhone(phone);
      showFieldError('phone', phoneError);
      if (phoneError) isValid = false;

      return isValid;
    }

    // Real-time validation
    function setupRealtimeValidation() {
      const fields = [
        { id: 'recipient', validator: validateName },
        { id: 'email', validator: validateEmail },
        { id: 'phone', validator: validatePhone }
      ];

      fields.forEach(({ id, validator }) => {
        const field = document.getElementById(id);
        field.addEventListener('blur', () => {
          const value = field.value.trim();
          const error = validator(value);
          showFieldError(id, error);
        });

        field.addEventListener('input', () => {
          // Clear error when user starts typing
          if (field.classList.contains('error-input')) {
            showFieldError(id, null);
          }
        });
      });
    }

    // ====== Order Code Generator ======
    function generateOrderCode() {
      const now = new Date();
      const dateStr = now.getFullYear() + 
                     String(now.getMonth() + 1).padStart(2, '0') + 
                     String(now.getDate()).padStart(2, '0');
      
      // Get today's counter from memory
      const today = `ANR-${dateStr}`;
      let counter = getOrderCounter(today);
      counter++;
      setOrderCounter(today, counter);
      
      return `${today}-${String(counter).padStart(3, '0')}`;
    }

    function getOrderCounter(prefix) {
      const stored = orderDatabase[prefix] || 0;
      return stored;
    }

    function setOrderCounter(prefix, count) {
      orderDatabase[prefix] = count;
    }

    // Simple in-memory database for this session
    let orderDatabase = {};

    // ====== QR Code Management ======
    let qrTimer = null;
    let qrTimeLeft = 600; // 10 minutes

    function generateVietQR(amount, orderCode) {
      // VietQR format - simplified version
      const bankCode = "970436"; // Vietcombank
      const accountNo = "0123456789"; // Replace with real account
      const qrData = `${bankCode}|${accountNo}|${amount}|${orderCode}|ANARO COFFEE`;
      
      // For demo, we'll use a placeholder QR
      return `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(qrData)}`;
    }

    function showQRCode(orderCode, amount) {
      const qrSection = document.getElementById('qr-section');
      const qrCodeDiv = document.getElementById('qr-code');
      
      // Generate QR image
      const qrUrl = generateVietQR(amount, orderCode);
      qrCodeDiv.innerHTML = `<img src="${qrUrl}" alt="QR Code thanh to√°n" style="width:100%;height:100%;object-fit:contain;">`;
      
      // Update payment info
      document.getElementById('qr-amount').textContent = fmt(amount);
      document.getElementById('qr-content').textContent = orderCode;
      
      // Show section
      qrSection.style.display = 'block';
      
      // Start timer
      startQRTimer();
    }

    function startQRTimer() {
      qrTimeLeft = 600; // Reset to 10 minutes
      updateTimerDisplay();
      
      qrTimer = setInterval(() => {
        qrTimeLeft--;
        updateTimerDisplay();
        
        if (qrTimeLeft <= 0) {
          clearInterval(qrTimer);
          document.getElementById('qr-code').innerHTML = '<div class="qr-placeholder"><div>‚è∞ M√£ QR ƒë√£ h·∫øt h·∫°n</div></div>';
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(qrTimeLeft / 60);
      const seconds = qrTimeLeft % 60;
      document.getElementById('timer').textContent = 
        `${minutes}:${String(seconds).padStart(2, '0')}`;
    }

    function hideQRCode() {
      document.getElementById('qr-section').style.display = 'none';
      if (qrTimer) {
        clearInterval(qrTimer);
        qrTimer = null;
      }
    }

    // ====== Analytics Tracking ======
    const analytics = {
      events: [],
      
      track(event, data = {}) {
        const timestamp = new Date().toISOString();
        this.events.push({ event, data, timestamp });
        console.log(`üìä Analytics: ${event}`, data);
      },
      
      getEvents() {
        return this.events;
      }
    };

    // ====== Payment Method Handling ======
    function setupPaymentMethods() {
      const paymentInputs = document.querySelectorAll('input[name="payment"]');
      
      paymentInputs.forEach(input => {
        input.addEventListener('change', (e) => {
          const method = e.target.value;
          analytics.track('payment_method_selected', { method });
          
          if (method === 'qr') {
            const payload = readPayloadFromHash() || {};
            const orderCode = generateOrderCode();
            document.getElementById('order-code').textContent = orderCode;
            showQRCode(orderCode, payload.total || 828000);
            
            // Update button text
            document.getElementById('order-text').textContent = 'X√°c nh·∫≠n thanh to√°n';
          } else {
            hideQRCode();
            document.getElementById('order-text').textContent = 'ƒê·∫∑t h√†ng';
          }
        });
      });
      
      // Refresh QR button
      document.getElementById('refresh-qr').addEventListener('click', () => {
        const orderCode = document.getElementById('order-code').textContent;
        const payload = readPayloadFromHash() || {};
        showQRCode(orderCode, payload.total || 828000);
        analytics.track('qr_refreshed', { orderCode });
      });
    }
    const fmt = n => (n||0).toLocaleString('vi-VN') + "ƒë";
    
    function showToast(msg, type = 'info'){
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    function showPopup(){
      const bd = document.getElementById('backdrop');
      bd.style.display = 'flex';
      setTimeout(() => bd.classList.add('show'), 10);
    }

    function hidePopup(){
      const bd = document.getElementById('backdrop');
      bd.classList.remove('show');
      setTimeout(() => bd.style.display = 'none', 200);
    }

    document.getElementById('backdrop').addEventListener('click', (e) => {
      if (e.target.id === 'backdrop') hidePopup();
    });

    function readPayloadFromHash(){
      try{
        const m = location.hash.match(/[#&]p=([^&]+)/);
        if(!m) return null;
        const json = decodeURIComponent(escape(atob(m[1])));
        return JSON.parse(json);
      }catch(e){ return null; }
    }

    function bindSocialLinks(){
      document.getElementById('linkZalo').href = SOCIAL_LINKS.zalo;
      document.getElementById('linkMsg').href  = SOCIAL_LINKS.messenger;
      document.getElementById('linkFan').href  = SOCIAL_LINKS.fanpage;

      document.getElementById('okZalo').href = SOCIAL_LINKS.zalo;
      document.getElementById('okMsg').href  = SOCIAL_LINKS.messenger;
      document.getElementById('okFan').href  = SOCIAL_LINKS.fanpage;
    }

    function renderOrderSummary(payload){
      if(!payload) return;
      const { items=[], subtotal=0, weightKg=0, shipping=0, total=0 } = payload;
      document.getElementById('co-subtotal').textContent = fmt(subtotal);
      document.getElementById('co-weight').textContent   = (weightKg||0).toFixed(2) + " kg";
      document.getElementById('co-ship').textContent     = fmt(shipping);
      document.getElementById('co-total').textContent    = fmt(total);
      const lines = items.map(it => `‚Ä¢ ${it.name} ‚Äî ${it.size} ‚Äî ${it.grind} √ó ${it.qty}`).join('<br>');
      document.getElementById('co-items').innerHTML = lines || '';
    }

    function getRecipient(){
      const name = document.getElementById('recipient').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const note = document.getElementById('note').value.trim();
      const g = document.querySelector('input[name="gender"]:checked');
      const gender = g ? g.value : "Anh";
      return { name, email, phone, note, gender };
    }

    async function sendOrderByEmail(payload){
      const r = payload.recipient || {};
      const itemsStr = (payload.items||[]).map(i=>`${i.name} ‚Äî ${i.size} ‚Äî ${i.grind} √ó ${i.qty}`).join("; ");
      const body = {
        _subject: "ƒê∆°n h√†ng m·ªõi t·ª´ ANARO COFFEE",
        _template: "table",
        "Ng∆∞·ªùi nh·∫≠n": `${r.gender||""} ${r.name||""}`.trim(),
        "Email": r.email||"",
        "SƒêT": r.phone||"",
        "Ghi ch√∫": r.note||"",
        "Ti·ªÅn h√†ng": (payload.subtotal||0),
        "Ph√≠ ship": (payload.shipping||0),
        "T·ªïng": (payload.total||0),
        "C√¢n n·∫∑ng (kg)": (payload.weightKg||0),
        "Chi ti·∫øt": itemsStr,
        "JSON": JSON.stringify(payload)
      };

      const res = await fetch(FORM_ENDPOINT, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json", 
          "Accept": "application/json" 
        },
        body: JSON.stringify(body)
      });
      
      if(!res.ok){ 
        throw new Error(`HTTP ${res.status}: ${await res.text()}`); 
      }
      return res.json().catch(() => ({}));
    }

    // ====== Order Submission ======
    document.getElementById('placeOrder').addEventListener('click', async (e) => {
      e.preventDefault();
      
      analytics.track('checkout_attempt');
      
      // Validate form first
      if (!validateForm()) {
        analytics.track('checkout_validation_failed');
        showToast("Vui l√≤ng ki·ªÉm tra v√† ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin", "error");
        return;
      }

      const btn = e.target;
      const orderTextSpan = document.getElementById('order-text');
      const loadingSpan = document.getElementById('order-loading');
      
      try {
        // Show loading state
        btn.disabled = true;
        orderTextSpan.style.display = 'none';
        loadingSpan.style.display = 'flex';

        const payload = readPayloadFromHash() || {};
        payload.recipient = getRecipient();
        payload.contact = { ...SOCIAL_LINKS };
        payload.timestamp = new Date().toISOString();
        
        // Generate or get existing order code
        let orderCode = document.getElementById('order-code').textContent;
        if (orderCode === 'ƒêang t·∫°o...') {
          orderCode = generateOrderCode();
          document.getElementById('order-code').textContent = orderCode;
        }
        payload.orderCode = orderCode;
        
        // Get selected payment method
        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
        payload.paymentMethod = paymentMethod;

        analytics.track('order_submitting', { 
          orderCode, 
          paymentMethod, 
          total: payload.total 
        });

        await sendOrderByEmail(payload);
        
        // Update success popup with order code
        document.getElementById('success-order-code').textContent = orderCode;
        
        analytics.track('order_success', { 
          orderCode, 
          paymentMethod, 
          total: payload.total 
        });
        
        showToast("ƒê·∫∑t h√†ng th√†nh c√¥ng!", "success");
        showPopup();
        
      } catch (err) {
        console.error('Order submission error:', err);
        analytics.track('order_failed', { error: err.message });
        showToast("G·ª≠i ƒë∆°n th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá qua Zalo.", "error");
      } finally {
        // Reset button state
        btn.disabled = false;
        orderTextSpan.style.display = 'inline';
        loadingSpan.style.display = 'none';
      }
    });

    // ====== Initialize ======
    (function init(){
      bindSocialLinks();
      renderOrderSummary(readPayloadFromHash());
      setupRealtimeValidation();
      setupPaymentMethods();
      
      // Generate initial order code
      const initialOrderCode = generateOrderCode();
      document.getElementById('order-code').textContent = initialOrderCode;
      
      // Track page view
      analytics.track('checkout_page_viewed', {
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        viewport: `${window.innerWidth}x${window.innerHeight}`
      });
    })();
  </script>
</body>
</html>
