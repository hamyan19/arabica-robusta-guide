<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thanh to√°n</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7eee7;margin:0;color:#333}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.06);margin-bottom:16px}
    h1{font-size:24px;margin:0 0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full{grid-column:1/-1}
    label{display:block;font-size:14px;margin-bottom:6px;color:#555}
    input,textarea{width:100%;box-sizing:border-box;padding:12px 14px;border:1px solid #ddd;border-radius:10px;background:#fafafa}
    textarea{min-height:90px;resize:vertical}
    .btn{display:inline-block;padding:12px 18px;border-radius:12px;border:none;background:#111;color:#fff;cursor:pointer;font-weight:600}
    .muted{color:#666;font-size:14px}
    .right{float:right}
    .total{font-weight:700}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
    .ok{color:#0a7a3e}.warn{color:#b65700}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Thanh to√°n</h1>

    <div class="card">
      <p class="muted">Ph∆∞∆°ng √°n nhanh: g·ª≠i form qua <b>FormSubmit</b> (AJAX) ‚Üí m·ªü <b>trang c·∫£m ∆°n</b> c·ªßa b·∫°n ·ªü tab m·ªõi.</p>
      <p class="muted">üí° L·∫ßn ƒë·∫ßu FormSubmit s·∫Ω g·ª≠i email x√°c minh ƒë·∫øn <b>anmy1909@gmail.com</b>. B·∫•m ‚ÄúVerify‚Äù ƒë·ªÉ b·∫≠t vƒ©nh vi·ªÖn.</p>
    </div>

    <!-- KH√îNG d√πng action/target: ƒë·ªÉ JS g·ª≠i AJAX -->
    <form id="checkoutForm" class="card">
      <div class="grid">
        <div>
          <label for="email">Email</label>
          <input id="email" name="Email" type="email" required placeholder="you@email.com"/>
        </div>
        <div>
          <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
          <input id="phone" name="SƒêT" type="tel" required placeholder="09xxxxxxxx"/>
        </div>
        <div class="full">
          <label for="address">ƒê·ªãa ch·ªâ</label>
          <input id="address" name="ƒê·ªãa_ch·ªâ" type="text" required placeholder="S·ªë nh√†, ƒë∆∞·ªùng, qu·∫≠n/huy·ªán, t·ªânh/th√†nh"/>
        </div>
        <div class="full">
          <label for="note">Ghi ch√∫</label>
          <textarea id="note" name="Ghi_ch√∫" placeholder="Y√™u c·∫ßu th√™m (n·∫øu c√≥)"></textarea>
        </div>
      </div>

      <!-- ·∫©n: d·ªØ li·ªáu ƒë∆°n -->
      <input type="hidden" name="M√£_ƒë∆°n" id="orderId">
      <input type="hidden" name="Gi·ªè_h√†ng" id="cartText">
      <input type="hidden" name="T·ªïng_ti·ªÅn" id="totalText">
      <input type="hidden" name="Cart_JSON" id="cartJson">

      <!-- c·∫•u h√¨nh email / template (FormSubmit v·∫´n nh·∫≠n c√°c field n√†y trong payload) -->
      <input type="hidden" name="_subject" value="ƒê∆°n h√†ng m·ªõi t·ª´ website">
      <input type="hidden" name="_template" value="table">

      <button class="btn" type="submit">G·ª≠i ƒë∆°n</button>
      <span id="guard" class="muted right"></span>
    </form>

    <div class="card">
      <table class="table" id="cartPreview">
        <thead><tr><th>S·∫£n ph·∫©m</th><th>SL</th><th>Th√†nh ti·ªÅn</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td class="total">T·ªïng c·ªông</td><td></td><td class="total" id="sumCell">0ƒë</td></tr></tfoot>
      </table>
    </div>
  </div>

  <script>
    // ==== ƒê·ªçc gi·ªè h√†ng (∆∞u ti√™n hash #p=..., fallback localStorage) ====
    function readCartFromHash(){
      try{
        const m = location.hash.match(/[#&]p=([^&]+)/);
        if(!m) return null;
        const json = decodeURIComponent(escape(atob(m[1])));
        const obj = JSON.parse(json);
        if (Array.isArray(obj.items)) return obj;
      }catch(e){}
      return null;
    }
    const payload = readCartFromHash();

    function loadFromLocal(){
      const keys = ['anaro_cart','cart','gioHang','cartItems'];
      for(const k of keys){
        const v = localStorage.getItem(k);
        if(v && v !== '[]' && v !== '{}'){ try { return JSON.parse(v)||[] } catch(e){} }
      }
      return [];
    }

    let items = payload ? payload.items : loadFromLocal();

    // Chu·∫©n ho√°
    const neatVND = n => (Number(n)||0).toLocaleString('vi-VN') + 'ƒë';
    const norm = i => ({
      name: i.name || i.title || i.productName || 'S·∫£n ph·∫©m',
      qty:  Number(i.qty ?? i.quantity ?? i.count ?? 1),
      price: Number(i.price ?? i.unitPrice ?? i.gia ?? 0),
      size:  i.size || i.khoiLuong || ''
    });
    const nitems = items.map(norm);
    const total = payload ? Number(payload.total||0) : nitems.reduce((s,i)=>s+i.price*i.qty,0);

    // Render preview
    const tbody = document.querySelector('#cartPreview tbody');
    if(nitems.length){
      tbody.innerHTML = nitems.map(i=>`<tr>
        <td>${i.name}${i.size?` ‚Äî ${i.size}`:''}</td>
        <td>${i.qty}</td>
        <td>${neatVND(i.price*i.qty)}</td>
      </tr>`).join('');
    }else{
      tbody.innerHTML = `<tr><td colspan="3" class="muted">Gi·ªè h√†ng tr·ªëng.</td></tr>`;
    }
    document.getElementById('sumCell').textContent = neatVND(total);

    // Hidden fields
    const orderId = 'DH' + Date.now().toString(36).toUpperCase();
    document.getElementById('orderId').value   = orderId;
    document.getElementById('cartText').value  = nitems.map(i=>`${i.name}${i.size?` (${i.size})`:''} x${i.qty} ‚Äî ${neatVND(i.price*i.qty)}`).join('\n');
    document.getElementById('totalText').value = neatVND(total);
    document.getElementById('cartJson').value  = JSON.stringify(nitems);

    // ==== G·ª≠i AJAX t·ªõi FormSubmit ====
    const ENDPOINT = 'https://formsubmit.co/ajax/anmy1909@gmail.com';
    const form = document.getElementById('checkoutForm');
    const guard = document.getElementById('guard');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!nitems.length) {
        guard.textContent = 'Gi·ªè h√†ng tr·ªëng, kh√¥ng th·ªÉ g·ª≠i.';
        guard.className = 'muted warn right';
        return;
      }
      guard.textContent = `ƒêang g·ª≠i‚Ä¶ (${orderId})`;
      guard.className = 'muted ok right';

      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());

      try {
        const res = await fetch(ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('FormSubmit tr·∫£ v·ªÅ l·ªói ' + res.status);

        // Th√†nh c√¥ng: m·ªü trang c·∫£m ∆°n (tab m·ªõi) + d·ªçn gi·ªè (n·∫øu c√πng origin)
        window.open('/thanks.html', '_blank', 'noopener');
        try { localStorage.removeItem('anaro_cart'); } catch (_) {}
        guard.textContent = 'ƒê√£ g·ª≠i xong!';
      } catch (err) {
        guard.textContent = 'G·ª≠i th·∫•t b·∫°i: ' + err.message;
        guard.className = 'muted warn right';
      }
    });
  </script>
</body>
</html>
