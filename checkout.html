<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ANARO — Checkout</title>
  <style>
    :root{--bg:#fffdf9;--text:#2a221d;--muted:#6e625a;--border:#eadfd4}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:22px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .title{margin:0 0 8px 0;font-size:16px}
    label{font-size:13px;font-weight:700;color:#6b3f25}
    input[type="text"], input[type="email"], textarea{padding:10px;border:1px solid #0002;border-radius:10px;width:100%}
    textarea{min-height:90px;resize:vertical}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .gender{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .opt{display:flex;gap:6px;align-items:center;padding:8px 10px;border:1px solid #0001;border-radius:10px;background:#0001;cursor:pointer}
    .line{display:flex;justify-content:space-between;margin:6px 0}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #0001;background:#0001;color:#1e1e1e;font-weight:800;cursor:pointer;text-decoration:none}
    .cta{background:#F8EBDD;border-color:transparent}
    .srow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ico{width:18px;height:18px;display:inline-block}
    footer{margin-top:24px;color:#6e625a;font-size:12px;text-align:center}
    .toast{position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#2a221d;color:#fff;padding:10px 14px;border-radius:10px;z-index:9999}
    @media (max-width:880px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>☕ ANARO COFFEE — Thanh toán</h1>
      <a class="btn" href="index.html">← Tiếp tục mua</a>
    </header>

    <div class="grid">
      <!-- LEFT: Customer Info -->
      <section class="card">
        <h2 class="title">Thông tin người nhận</h2>
        <div class="row2">
          <div>
            <label for="recipient">Tên người nhận</label>
            <input id="recipient" type="text" placeholder="VD: Nguyễn Văn A" />
          </div>
          <div>
            <label>Giới tính (xưng hô)</label>
            <div class="gender">
              <label class="opt"><input type="radio" name="gender" value="Anh" checked /> Anh</label>
              <label class="opt"><input type="radio" name="gender" value="Chị" /> Chị</label>
              <label class="opt"><input type="radio" name="gender" value="Khác" /> Khác</label>
            </div>
          </div>
        </div>
        <div class="row2" style="margin-top:10px">
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="you@example.com" />
          </div>
          <div>
            <label for="phone">Số điện thoại</label>
            <input id="phone" type="text" placeholder="09xx xxx xxx" />
          </div>
        </div>
        <div style="margin-top:10px">
          <label for="note">Ghi chú</label>
          <textarea id="note" placeholder="Ghi chú thêm (khung giờ nhận, địa chỉ chi tiết, v.v.)"></textarea>
        </div>

        <h3 class="title" style="margin-top:14px">Liên hệ / Xác nhận đơn</h3>
        <div class="srow">
          <a id="linkZalo" class="btn" target="_blank" rel="noopener" href="#" aria-label="Zalo">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="5" ry="5" fill="#0068FF"/><text x="6.7" y="16.5" font-family="Segoe UI, Roboto, Helvetica, Arial" font-size="10" fill="#fff" font-weight="700">Z</text></svg>
            </span>
            <span>Zalo</span>
          </a>
          <a id="linkMsg" class="btn" target="_blank" rel="noopener" href="#" aria-label="Messenger">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#0099FF"/><path d="M6.5 14.2l4.1-3.1 3.1 3.1 3.3-3.1" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            <span>Messenger</span>
          </a>
          <a id="linkFan" class="btn" target="_blank" rel="noopener" href="#" aria-label="Fanpage Facebook">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="5" ry="5" fill="#1877F2"/><path d="M14 8h2V6h-2a3 3 0 0 0-3 3v2H9v2h2v5h2v-5h2l1-2h-3V9a1 1 0 0 1 1-1z" fill="#fff"/></svg>
            </span>
            <span>Fanpage</span>
          </a>
        </div>
      </section>

      <!-- RIGHT: Order Summary -->
      <section class="card">
        <h2 class="title">Đơn hàng</h2>
        <div class="line"><strong>Tiền hàng</strong><span id="co-subtotal">0đ</span></div>
        <div class="line"><span>Cân nặng</span><span id="co-weight">0 kg</span></div>
        <div class="line"><span>Phí ship</span><span id="co-ship">0đ</span></div>
        <div class="line"><strong>Tổng</strong><strong id="co-total">0đ</strong></div>
        <div class="muted" id="co-items" style="margin-top:8px"></div>
        <div style="margin-top:12px">
          <button id="placeOrder" class="btn cta">Đặt hàng</button>
        </div>
      </section>
    </div>

    <footer>ANARO COFFEE · © 2025</footer>
  </div>

  <script>
    // ====== Config ======
    const FORM_EMAIL = "anmy1909@gmail.com"; // <-- đổi nếu cần
    const FORM_ENDPOINT = "https://formsubmit.co/ajax/" + encodeURIComponent(FORM_EMAIL);

    // Social links
    const SOCIAL_LINKS = {
      zalo: "https://zalo.me/84918337071",
      messenger: "https://m.me/anarocoffee",
      fanpage: "https://www.facebook.com/anarocoffee/"
    };

    // ====== Helpers ======
    const fmt = n => (n||0).toLocaleString('vi-VN') + "đ";
    function showToast(msg){
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 2600);
    }

    function readPayloadFromHash(){
      try{
        const m = location.hash.match(/[#&]p=([^&]+)/);
        if(!m) return null;
        const json = decodeURIComponent(escape(atob(m[1])));
        return JSON.parse(json);
      }catch(e){ return null; }
    }

    function bindSocialLinks(){
      document.getElementById('linkZalo').href = SOCIAL_LINKS.zalo;
      document.getElementById('linkMsg').href  = SOCIAL_LINKS.messenger;
      document.getElementById('linkFan').href  = SOCIAL_LINKS.fanpage;
    }

    function renderOrderSummary(payload){
      if(!payload) return;
      const { items=[], subtotal=0, weightKg=0, shipping=0, total=0 } = payload;
      document.getElementById('co-subtotal').textContent = fmt(subtotal);
      document.getElementById('co-weight').textContent   = (weightKg||0).toFixed(2) + " kg";
      document.getElementById('co-ship').textContent     = fmt(shipping);
      document.getElementById('co-total').textContent    = fmt(total);
      const lines = items.map(it => `• ${it.name} — ${it.size} — ${it.grind} × ${it.qty}`).join('<br>');
      document.getElementById('co-items').innerHTML = lines || '';
    }

    function getRecipient(){
      const name = document.getElementById('recipient').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const note = document.getElementById('note').value.trim();
      const g = document.querySelector('input[name="gender"]:checked');
      const gender = g ? g.value : "Anh";
      return { name, email, phone, note, gender };
    }

    async function sendOrderByEmail(payload){
      // Chuyển payload sang dữ liệu dễ đọc trong email
      const r = payload.recipient || {};
      const itemsStr = (payload.items||[]).map(i=>`${i.name} — ${i.size} — ${i.grind} × ${i.qty}`).join("; ");
      const body = {
        _subject: "Đơn hàng mới từ ANARO COFFEE",
        _template: "table",
        "Người nhận": `${r.gender||""} ${r.name||""}`.trim(),
        "Email": r.email||"",
        "SĐT": r.phone||"",
        "Ghi chú": r.note||"",
        "Tiền hàng": (payload.subtotal||0),
        "Phí ship": (payload.shipping||0),
        "Tổng": (payload.total||0),
        "Cân nặng (kg)": (payload.weightKg||0),
        "Chi tiết": itemsStr,
        "JSON": JSON.stringify(payload)
      };

      const res = await fetch(FORM_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(body)
      });

      if(!res.ok){
        const txt = await res.text().catch(()=>'');
        throw new Error("Submit failed: " + txt);
      }
      return res.json().catch(()=>({}));
    }

    document.getElementById('placeOrder').addEventListener('click', async ()=>{
      try{
        const payload = readPayloadFromHash() || {};
        payload.recipient = getRecipient();
        payload.contact = { ...SOCIAL_LINKS };

        // Gửi email (AJAX) & redirect nội bộ
        await sendOrderByEmail(payload);
        location.href = "thank-you.html";
      }catch(err){
        console.error(err);
        showToast("Gửi đơn thất bại, vui lòng thử lại.");
      }
    });

    (function init(){
      bindSocialLinks();
      renderOrderSummary(readPayloadFromHash());
    })();
  </script>
</body>
</html>
