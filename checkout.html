<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thanh toán</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7eee7;margin:0;color:#333}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.06);margin-bottom:16px}
    h1{font-size:24px;margin:0 0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full{grid-column:1/-1}
    label{display:block;font-size:14px;margin-bottom:6px;color:#555}
    input,textarea{width:100%;box-sizing:border-box;padding:12px 14px;border:1px solid #ddd;border-radius:10px;background:#fafafa}
    textarea{min-height:90px;resize:vertical}
    .btn{display:inline-block;padding:12px 18px;border-radius:12px;border:none;background:#111;color:#fff;cursor:pointer;font-weight:600}
    .muted{color:#666;font-size:14px}
    .right{float:right}
    .total{font-weight:700}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
    .ok{color:#0a7a3e}.warn{color:#b65700}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Thanh toán</h1>
    <form id="checkoutForm" class="card">
      <div class="grid">
        <div>
          <label for="email">Email</label>
          <input id="email" name="Email" type="email" required placeholder="you@email.com"/>
        </div>
        <div>
          <label for="phone">Số điện thoại</label>
          <input id="phone" name="SĐT" type="tel" required placeholder="09xxxxxxxx"/>
        </div>
        <div class="full">
          <label for="address">Địa chỉ</label>
          <input id="address" name="Địa_chỉ" type="text" required placeholder="Số nhà, đường, quận/huyện, tỉnh/thành"/>
        </div>
        <div class="full">
          <label for="note">Ghi chú</label>
          <textarea id="note" name="Ghi_chú" placeholder="Yêu cầu thêm (nếu có)"></textarea>
        </div>
      </div>

      <!-- ẩn: dữ liệu đơn -->
      <input type="hidden" name="Mã_đơn" id="orderId">
      <input type="hidden" name="Giỏ_hàng" id="cartText">
      <input type="hidden" name="Tổng_tiền" id="totalText">
      <input type="hidden" name="Cart_JSON" id="cartJson">

      <!-- cấu hình email / template (FormSubmit vẫn nhận các field này trong payload) -->
      <input type="hidden" name="_subject" value="Đơn hàng mới từ website">
      <input type="hidden" name="_template" value="table">

      <button class="btn" type="submit">Gửi đơn</button>
      <span id="guard" class="muted right"></span>
    </form>

    <div class="card">
      <table class="table" id="cartPreview">
        <thead><tr><th>Sản phẩm</th><th>SL</th><th>Thành tiền</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td class="total">Tổng cộng</td><td></td><td class="total" id="sumCell">0đ</td></tr></tfoot>
      </table>
    </div>
  </div>

  <script>
    // ==== Đọc giỏ hàng (ưu tiên hash #p=..., fallback localStorage) ====
    function readCartFromHash(){
      try{
        const m = location.hash.match(/[#&]p=([^&]+)/);
        if(!m) return null;
        const json = decodeURIComponent(escape(atob(m[1])));
        const obj = JSON.parse(json);
        if (Array.isArray(obj.items)) return obj;
      }catch(e){}
      return null;
    }
    const payload = readCartFromHash();

    function loadFromLocal(){
      const keys = ['anaro_cart','cart','gioHang','cartItems'];
      for(const k of keys){
        const v = localStorage.getItem(k);
        if(v && v !== '[]' && v !== '{}'){ try { return JSON.parse(v)||[] } catch(e){} }
      }
      return [];
    }

    let items = payload ? payload.items : loadFromLocal();

    // Chuẩn hoá
    const neatVND = n => (Number(n)||0).toLocaleString('vi-VN') + 'đ';
    const norm = i => ({
      name: i.name || i.title || i.productName || 'Sản phẩm',
      qty:  Number(i.qty ?? i.quantity ?? i.count ?? 1),
      price: Number(i.price ?? i.unitPrice ?? i.gia ?? 0),
      size:  i.size || i.khoiLuong || ''
    });
    const nitems = items.map(norm);
    const total = payload ? Number(payload.total||0) : nitems.reduce((s,i)=>s+i.price*i.qty,0);

    // Render preview
    const tbody = document.querySelector('#cartPreview tbody');
    if(nitems.length){
      tbody.innerHTML = nitems.map(i=>`<tr>
        <td>${i.name}${i.size?` — ${i.size}`:''}</td>
        <td>${i.qty}</td>
        <td>${neatVND(i.price*i.qty)}</td>
      </tr>`).join('');
    }else{
      tbody.innerHTML = `<tr><td colspan="3" class="muted">Giỏ hàng trống.</td></tr>`;
    }
    document.getElementById('sumCell').textContent = neatVND(total);

    // Hidden fields
    const orderId = 'DH' + Date.now().toString(36).toUpperCase();
    document.getElementById('orderId').value   = orderId;
    document.getElementById('cartText').value  = nitems.map(i=>`${i.name}${i.size?` (${i.size})`:''} x${i.qty} — ${neatVND(i.price*i.qty)}`).join('\n');
    document.getElementById('totalText').value = neatVND(total);
    document.getElementById('cartJson').value  = JSON.stringify(nitems);

    // ==== Gửi AJAX tới FormSubmit ====
    const ENDPOINT = 'https://formsubmit.co/ajax/anmy1909@gmail.com';
    const form = document.getElementById('checkoutForm');
    const guard = document.getElementById('guard');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!nitems.length) {
        guard.textContent = 'Giỏ hàng trống, không thể gửi.';
        guard.className = 'muted warn right';
        return;
      }
      guard.textContent = `Đang gửi… (${orderId})`;
      guard.className = 'muted ok right';

      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());

      try {
        const res = await fetch(ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('FormSubmit trả về lỗi ' + res.status);

        // Thành công: mở trang cảm ơn (tab mới) + dọn giỏ (nếu cùng origin)
        window.open('/thanks.html', '_blank', 'noopener');
        try { localStorage.removeItem('anaro_cart'); } catch (_) {}
        guard.textContent = 'Đã gửi xong!';
      } catch (err) {
        guard.textContent = 'Gửi thất bại: ' + err.message;
        guard.className = 'muted warn right';
      }
    });
  </script>
</body>
</html>

