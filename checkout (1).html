<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thanh to√°n ‚Äî ANARO Coffee</title>
  <style>
    :root{--bg:#f6efe9;--text:#2a221d;--card:#fff;--border:#e9d7c5}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#fff,var(--bg) 50%,#f0e2d6);color:var(--text)}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 12px 0;font-size:22px;text-align:center}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media(max-width:860px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    label{font-weight:700}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid #0002;border-radius:10px;font:inherit}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:flex;gap:10px}
    .btn{flex:1;display:inline-flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:10px;border:1px solid #0001;background:#0001;color:#6b3f25;font-weight:800;text-decoration:none;cursor:pointer}
    .primary{background:#F8EBDD;border-color:transparent}
    .ok{color:#0a7b30}.err{color:#b00020}.hint{opacity:.75}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #0001;text-align:left}
    tfoot td{font-weight:900}

    /* Owner config panel (·∫©n, ch·ªâ hi·ªán khi #owner) */
    .owner{display:none;position:sticky;top:0;z-index:20;background:#fff4ec;border:1px dashed #d8b79e;padding:10px 12px;border-radius:10px;margin-bottom:12px}
    .owner.show{display:block}
    .owner input{width:100%;max-width:620px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Thanh to√°n</h1>

    <!-- B·∫£ng c·∫•u h√¨nh ·∫©n cho ch·ªß shop: ch·ªâ hi·ªán khi v√†o checkout.html#owner -->
    <div id="ownerPanel" class="owner">
      <strong>üîí Ch·ªß shop c·∫•u h√¨nh (ch·ªâ b·∫°n th·∫•y):</strong>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
        <label for="sheetsUrl">Google Apps Script Web App URL</label>
        <input id="sheetsUrl" type="url" placeholder="https://script.google.com/macros/s/....../exec" />
        <button id="saveUrl" class="btn">L∆∞u v√†o tr√¨nh duy·ªát</button>
        <span class="hint">(URL n√†y ch·ªâ l∆∞u ·ªü <em>localStorage</em> tr√™n m√°y b·∫°n, kh√¥ng hi·ªÉn th·ªã cho kh√°ch)</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <form id="checkoutForm">
          <div class="row">
            <div>
              <label>Email</label>
              <input name="email" type="email" placeholder="name@example.com" required />
            </div>
            <div>
              <label>S·ªë ƒëi·ªán tho·∫°i</label>
              <input name="phone" type="tel" placeholder="0918 337 071" required />
            </div>
          </div>
          <div>
            <label>ƒê·ªãa ch·ªâ</label>
            <input name="address" type="text" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh" required />
          </div>
          <div>
            <label>Ghi ch√∫</label>
            <input name="note" type="text" placeholder="Gi·ªù li√™n h·ªá / y√™u c·∫ßu kh√°c (n·∫øu c√≥)" />
          </div>

          <div class="actions">
            <button type="submit" class="btn primary">G·ª≠i ƒë∆°n</button>
            <a class="btn" href="index-cart.html">‚Üê Quay l·∫°i gi·ªè h√†ng</a>
          </div>
          <p id="msg" class="hint"></p>
        </form>
      </div>

      <div class="card">
        <h3>ƒê∆°n h√†ng c·ªßa b·∫°n</h3>
        <table id="summary"><thead><tr><th>S·∫£n ph·∫©m</th><th>SL</th><th>Gi√°</th><th>T·∫°m t√≠nh</th></tr></thead><tbody></tbody><tfoot><tr><td colspan="3">T·ªïng c·ªông</td><td id="grand">0ƒë</td></tr></tfoot></table>
      </div>
    </div>
  </div>

  <script>
    // ===== C·∫§U H√åNH ·∫®N (ch·ªß shop ch·ªçn ƒë√≠ch nh·∫≠n, KH√îNG hi·ªÉn th·ªã cho kh√°ch) =====
    // G·ª≠i v·ªÅ Google Sheets (an to√†n, kh√¥ng l·ªô secret)
    const DESTINATION = 'sheets';

    // N·∫øu mu·ªën hardcode tr·ª±c ti·∫øp URL c·ªßa Apps Script, d√°n v√†o ƒë√¢y:
    const SHEETS_WEB_APP_URL = ""; // v√≠ d·ª•: https://script.google.com/macros/s/AKfycb.../exec

    // Ho·∫∑c d√°n t·∫°m qua URL (?script=...) ho·∫∑c l∆∞u v√†o localStorage (panel #owner)
    const STORAGE_KEY = 'anaro_sheets_url';

    const fmt = n=> (n||0).toLocaleString('vi-VN')+"ƒë";

    // ===== NH·∫¨N GI·ªé H√ÄNG T·ª™ localStorage =====
    let cart = [];
    try{ cart = JSON.parse(localStorage.getItem('anaro_cart')||'[]') }catch(e){ cart=[] }

    const tbody = document.querySelector('#summary tbody');
    const grand = document.getElementById('grand');

    function renderSummary(){
      if(!cart.length){ tbody.innerHTML = '<tr><td colspan="4">Gi·ªè h√†ng tr·ªëng.</td></tr>'; grand.textContent = '0ƒë'; return; }
      let total = 0;
      tbody.innerHTML = cart.map(it=>{
        const sub = it.price * it.qty; total += sub;
        return `<tr><td>${it.name} ‚Äî ${it.size}</td><td>${it.qty}</td><td>${fmt(it.price)}</td><td>${fmt(sub)}</td></tr>`
      }).join('');
      grand.textContent = fmt(total);
    }
    renderSummary();

    // ===== CH·ª¶ SHOP: c·∫•u h√¨nh nhanh b·∫±ng hash #owner =====
    const ownerPanel = document.getElementById('ownerPanel');
    const inputUrl   = document.getElementById('sheetsUrl');
    const saveBtn    = document.getElementById('saveUrl');

    function resolveSheetsUrl(){
      if (SHEETS_WEB_APP_URL) return SHEETS_WEB_APP_URL;
      const fromStorage = localStorage.getItem(STORAGE_KEY);
      if (fromStorage) return fromStorage;
      const q = new URLSearchParams(location.search).get('script');
      if (q) { localStorage.setItem(STORAGE_KEY, q); return q; }
      return '';
    }

    function initOwnerPanel(){
      if (location.hash === '#owner'){
        ownerPanel.classList.add('show');
        inputUrl.value = resolveSheetsUrl();
        saveBtn.addEventListener('click', ()=>{
          if(!inputUrl.value) return alert('H√£y d√°n Web App URL');
          localStorage.setItem(STORAGE_KEY, inputUrl.value);
          alert('ƒê√£ l∆∞u URL v√†o tr√¨nh duy·ªát. B·∫°n c√≥ th·ªÉ ƒë√≥ng b·∫£ng v√† g·ª≠i th·ª≠ ƒë∆°n.');
        });
      }
    }
    initOwnerPanel();

    // ===== SUBMIT FORM =====
    const form = document.getElementById('checkoutForm');
    const msg  = document.getElementById('msg');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msg.className='hint'; msg.textContent='ƒêang g·ª≠i...';
      const data = Object.fromEntries(new FormData(form).entries());
      // G·ªôp gi·ªè h√†ng th√†nh text
      const lines = cart.map(it=>`${it.name} ‚Äî ${it.size} x${it.qty} = ${fmt(it.price*it.qty)}`);
      const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
      data.product = lines.join('\n');
      data.total = total;

      try{
        if(DESTINATION !== 'sheets') throw new Error('DESTINATION hi·ªán ch·ªâ h·ªó tr·ª£ sheets trong file n√†y');
        const url = resolveSheetsUrl();
        if(!url) throw new Error('Ch∆∞a c·∫•u h√¨nh SHEETS_WEB_APP_URL (v√†o checkout.html#owner ƒë·ªÉ d√°n URL, ho·∫∑c th√™m ?script=...)');
        const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        const j = await r.json();
        if(j.ok){ msg.className='ok'; msg.textContent='ƒê√£ g·ª≠i ƒë∆°n ‚Äî ch√∫ng t√¥i s·∫Ω li√™n h·ªá s·ªõm!'; localStorage.removeItem('anaro_cart'); }
        else throw new Error('Sheets tr·∫£ v·ªÅ l·ªói');
      }catch(err){ msg.className='err'; msg.textContent='G·ª≠i th·∫•t b·∫°i: '+(err.message||err); }
    });
  </script>
</body>
</html>
